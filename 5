-- WA Universal ESP v1.0 with Aimbot
-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- Drawing Cache
local ESP_Cache = {}

-- ESP Configuration
local ESPConfig = {
    Enabled = false,
    BoxESP = false,
    NameESP = false,
    TeamCheck = false,
    BoxStyle = "Corner",
    BoxThickness = 1,
    TextSize = 14,
    MaxDistance = 1000,
    EnemyColor = Color3.fromRGB(255, 25, 25),
    AllyColor = Color3.fromRGB(25, 255, 25),
}

-- Colors
local Colors = {
    Enemy = ESPConfig.EnemyColor,
    Ally = ESPConfig.AllyColor,
}

-- ========== AIMBOT SCRIPT (from GitHub) ==========
-- Environment
getgenv().Aimbot = {}
local Environment = getgenv().Aimbot

-- Aimbot Variables
local RequiredDistance, Typing, Running, Animation, ServiceConnections = 2000, false, false, nil, {}

-- Aimbot Settings
Environment.Settings = {
    Enabled = false,
    TeamCheck = false,
    AliveCheck = true,
    WallCheck = false,
    Sensitivity = 0,
    ThirdPerson = false,
    ThirdPersonSensitivity = 3,
    TriggerKey = "MouseButton2",
    Toggle = false,
    LockPart = "Head"
}

Environment.FOVSettings = {
    Enabled = true,
    Visible = true,
    Amount = 90,
    Color = Color3.fromRGB(255, 255, 255),
    LockedColor = Color3.fromRGB(255, 70, 70),
    Transparency = 0.5,
    Sides = 60,
    Thickness = 1,
    Filled = false
}

Environment.FOVCircle = Drawing.new("Circle")

-- Aimbot Functions
local function CancelLock()
    Environment.Locked = nil
    if Animation then Animation:Cancel() end
    Environment.FOVCircle.Color = Environment.FOVSettings.Color
end

local function GetClosestPlayer()
    if not Environment.Locked then
        RequiredDistance = (Environment.FOVSettings.Enabled and Environment.FOVSettings.Amount or 2000)

        for _, v in next, Players:GetPlayers() do
            if v ~= LocalPlayer then
                if v.Character and v.Character:FindFirstChild(Environment.Settings.LockPart) and v.Character:FindFirstChildOfClass("Humanoid") then
                    if Environment.Settings.TeamCheck and v.Team == LocalPlayer.Team then continue end
                    if Environment.Settings.AliveCheck and v.Character:FindFirstChildOfClass("Humanoid").Health <= 0 then continue end
                    if Environment.Settings.WallCheck and #(Camera:GetPartsObscuringTarget({v.Character[Environment.Settings.LockPart].Position}, v.Character:GetDescendants())) > 0 then continue end

                    local Vector, OnScreen = Camera:WorldToViewportPoint(v.Character[Environment.Settings.LockPart].Position)
                    local Distance = (Vector2.new(UserInputService:GetMouseLocation().X, UserInputService:GetMouseLocation().Y) - Vector2.new(Vector.X, Vector.Y)).Magnitude

                    if Distance < RequiredDistance and OnScreen then
                        RequiredDistance = Distance
                        Environment.Locked = v
                    end
                end
            end
        end
    elseif (Vector2.new(UserInputService:GetMouseLocation().X, UserInputService:GetMouseLocation().Y) - Vector2.new(Camera:WorldToViewportPoint(Environment.Locked.Character[Environment.Settings.LockPart].Position))).Magnitude > RequiredDistance then
        CancelLock()
    end
end

-- Typing Check
ServiceConnections.TypingStartedConnection = UserInputService.TextBoxFocused:Connect(function()
    Typing = true
end)

ServiceConnections.TypingEndedConnection = UserInputService.TextBoxFocusReleased:Connect(function()
    Typing = false
end)

-- Main Aimbot Loop
ServiceConnections.RenderSteppedConnection = RunService.RenderStepped:Connect(function()
    -- FOV Circle
    if Environment.FOVSettings.Enabled and Environment.Settings.Enabled then
        Environment.FOVCircle.Radius = Environment.FOVSettings.Amount
        Environment.FOVCircle.Thickness = Environment.FOVSettings.Thickness
        Environment.FOVCircle.Filled = Environment.FOVSettings.Filled
        Environment.FOVCircle.NumSides = Environment.FOVSettings.Sides
        Environment.FOVCircle.Color = Environment.FOVSettings.Color
        Environment.FOVCircle.Transparency = Environment.FOVSettings.Transparency
        Environment.FOVCircle.Visible = Environment.FOVSettings.Visible
        Environment.FOVCircle.Position = Vector2.new(UserInputService:GetMouseLocation().X, UserInputService:GetMouseLocation().Y)
    else
        Environment.FOVCircle.Visible = false
    end

    -- Aimbot Logic
    if Running and Environment.Settings.Enabled then
        GetClosestPlayer()

        if Environment.Locked then
            if Environment.Settings.ThirdPerson then
                Environment.Settings.ThirdPersonSensitivity = math.clamp(Environment.Settings.ThirdPersonSensitivity, 0.1, 5)
                local Vector = Camera:WorldToViewportPoint(Environment.Locked.Character[Environment.Settings.LockPart].Position)
                mousemoverel((Vector.X - UserInputService:GetMouseLocation().X) * Environment.Settings.ThirdPersonSensitivity, (Vector.Y - UserInputService:GetMouseLocation().Y) * Environment.Settings.ThirdPersonSensitivity)
            else
                if Environment.Settings.Sensitivity > 0 then
                    Animation = game:GetService("TweenService"):Create(Camera, TweenInfo.new(Environment.Settings.Sensitivity, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {CFrame = CFrame.new(Camera.CFrame.Position, Environment.Locked.Character[Environment.Settings.LockPart].Position)})
                    Animation:Play()
                else
                    Camera.CFrame = CFrame.new(Camera.CFrame.Position, Environment.Locked.Character[Environment.Settings.LockPart].Position)
                end
            end
            Environment.FOVCircle.Color = Environment.FOVSettings.LockedColor
        end
    end
end)

-- Input Handling
ServiceConnections.InputBeganConnection = UserInputService.InputBegan:Connect(function(Input)
    if not Typing then
        -- Check KeyCode
        pcall(function()
            if Input.KeyCode == Enum.KeyCode[Environment.Settings.TriggerKey] then
                if Environment.Settings.Toggle then
                    Running = not Running
                    if not Running then CancelLock() end
                else
                    Running = true
                end
            end
        end)
        -- Check UserInputType
        pcall(function()
            if Input.UserInputType == Enum.UserInputType[Environment.Settings.TriggerKey] then
                if Environment.Settings.Toggle then
                    Running = not Running
                    if not Running then CancelLock() end
                else
                    Running = true
                end
            end
        end)
    end
end)

ServiceConnections.InputEndedConnection = UserInputService.InputEnded:Connect(function(Input)
    if not Typing and not Environment.Settings.Toggle then
        pcall(function()
            if Input.KeyCode == Enum.KeyCode[Environment.Settings.TriggerKey] then
                Running = false; CancelLock()
            end
        end)
        pcall(function()
            if Input.UserInputType == Enum.UserInputType[Environment.Settings.TriggerKey] then
                Running = false; CancelLock()
            end
        end)
    end
end)

-- Aimbot Functions Table
Environment.Functions = {}
function Environment.Functions:Exit()
    for _, v in next, ServiceConnections do
        v:Disconnect()
    end
    if Environment.FOVCircle.Remove then Environment.FOVCircle:Remove() end
    getgenv().Aimbot = nil
end
-- ========== END AIMBOT SCRIPT ==========

-- ESP Functions
local function GetPlayerColor(player)
    return (ESPConfig.TeamCheck and player.Team == LocalPlayer.Team) and Colors.Ally or Colors.Enemy
end

local function CreateESP(player)
    if player == LocalPlayer then return end
    
    local objects = {
        Box = {
            Top = Drawing.new("Line"),
            Bottom = Drawing.new("Line"),
            Left = Drawing.new("Line"),
            Right = Drawing.new("Line"),
            TopLeft = Drawing.new("Line"),
            TopRight = Drawing.new("Line"),
            BottomLeft = Drawing.new("Line"),
            BottomRight = Drawing.new("Line")
        },
        Name = Drawing.new("Text"),
    }
    
    for _, line in pairs(objects.Box) do
        line.Visible = false
        line.Color = Colors.Enemy
        line.Thickness = ESPConfig.BoxThickness
    end
    
    objects.Name.Visible = false
    objects.Name.Center = true
    objects.Name.Outline = true
    objects.Name.Size = ESPConfig.TextSize
    objects.Name.Color = Colors.Enemy
    objects.Name.Font = 2
    
    ESP_Cache[player] = objects
end

local function RemoveESP(player)
    if ESP_Cache[player] then
        for _, obj in pairs(ESP_Cache[player]) do
            if type(obj) == "table" then
                for _, subObj in pairs(obj) do
                    pcall(function() subObj:Remove() end)
                end
            else
                pcall(function() obj:Remove() end)
            end
        end
        ESP_Cache[player] = nil
    end
end

local function UpdateESP(player)
    if not ESPConfig.Enabled then return end
    
    local objects = ESP_Cache[player]
    if not objects then
        CreateESP(player)
        objects = ESP_Cache[player]
    end
    if not objects then return end
    
    local character = player.Character
    if not character then
        for _, line in pairs(objects.Box) do line.Visible = false end
        objects.Name.Visible = false
        return
    end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
    local humanoid = character:FindFirstChild("Humanoid")
    
    if not rootPart or not humanoid or humanoid.Health <= 0 then
        for _, line in pairs(objects.Box) do line.Visible = false end
        objects.Name.Visible = false
        return
    end
    
    local pos, onScreen = Camera:WorldToViewportPoint(rootPart.Position)
    local distance = (rootPart.Position - Camera.CFrame.Position).Magnitude
    
    if not onScreen or distance > ESPConfig.MaxDistance then
        for _, line in pairs(objects.Box) do line.Visible = false end
        objects.Name.Visible = false
        return
    end
    
    local isTeam = ESPConfig.TeamCheck and player.Team == LocalPlayer.Team
    if isTeam then
        for _, line in pairs(objects.Box) do line.Visible = false end
        objects.Name.Visible = false
        return
    end
    
    local color = GetPlayerColor(player)
    
    -- Box calculations
    local size = character:GetExtentsSize()
    local cf = rootPart.CFrame
    local top = Camera:WorldToViewportPoint(cf * CFrame.new(0, size.Y/2, 0).Position)
    local bottom = Camera:WorldToViewportPoint(cf * CFrame.new(0, -size.Y/2, 0).Position)
    
    local screenHeight = math.abs(bottom.Y - top.Y)
    local boxWidth = screenHeight * 0.65
    local boxPos = Vector2.new(top.X - boxWidth/2, top.Y)
    local boxSize = Vector2.new(boxWidth, screenHeight)
    
    -- Box ESP
    if ESPConfig.BoxESP then
        for _, line in pairs(objects.Box) do line.Visible = false end
        
        if ESPConfig.BoxStyle == "Full" then
            objects.Box.Left.From = boxPos
            objects.Box.Left.To = boxPos + Vector2.new(0, boxSize.Y)
            objects.Box.Left.Visible = true
            
            objects.Box.Right.From = boxPos + Vector2.new(boxSize.X, 0)
            objects.Box.Right.To = boxPos + Vector2.new(boxSize.X, boxSize.Y)
            objects.Box.Right.Visible = true
            
            objects.Box.Top.From = boxPos
            objects.Box.Top.To = boxPos + Vector2.new(boxSize.X, 0)
            objects.Box.Top.Visible = true
            
            objects.Box.Bottom.From = boxPos + Vector2.new(0, boxSize.Y)
            objects.Box.Bottom.To = boxPos + Vector2.new(boxSize.X, boxSize.Y)
            objects.Box.Bottom.Visible = true
        else
            local cornerSize = math.min(boxWidth * 0.2, 20)
            
            objects.Box.TopLeft.From = boxPos
            objects.Box.TopLeft.To = boxPos + Vector2.new(cornerSize, 0)
            objects.Box.TopLeft.Visible = true
            
            objects.Box.Left.From = boxPos
            objects.Box.Left.To = boxPos + Vector2.new(0, cornerSize)
            objects.Box.Left.Visible = true
            
            objects.Box.TopRight.From = boxPos + Vector2.new(boxSize.X, 0)
            objects.Box.TopRight.To = boxPos + Vector2.new(boxSize.X - cornerSize, 0)
            objects.Box.TopRight.Visible = true
            
            objects.Box.Right.From = boxPos + Vector2.new(boxSize.X, 0)
            objects.Box.Right.To = boxPos + Vector2.new(boxSize.X, cornerSize)
            objects.Box.Right.Visible = true
            
            objects.Box.BottomLeft.From = boxPos + Vector2.new(0, boxSize.Y)
            objects.Box.BottomLeft.To = boxPos + Vector2.new(cornerSize, boxSize.Y)
            objects.Box.BottomLeft.Visible = true
            
            objects.Box.Bottom.From = boxPos + Vector2.new(0, boxSize.Y)
            objects.Box.Bottom.To = boxPos + Vector2.new(0, boxSize.Y - cornerSize)
            objects.Box.Bottom.Visible = true
            
            objects.Box.BottomRight.From = boxPos + Vector2.new(boxSize.X, boxSize.Y)
            objects.Box.BottomRight.To = boxPos + Vector2.new(boxSize.X - cornerSize, boxSize.Y)
            objects.Box.BottomRight.Visible = true
            
            objects.Box.Top.From = boxPos + Vector2.new(boxSize.X, boxSize.Y)
            objects.Box.Top.To = boxPos + Vector2.new(boxSize.X, boxSize.Y - cornerSize)
            objects.Box.Top.Visible = true
        end
        
        for _, line in pairs(objects.Box) do
            if line.Visible then
                line.Color = color
                line.Thickness = ESPConfig.BoxThickness
            end
        end
    else
        for _, line in pairs(objects.Box) do line.Visible = false end
    end
    
    -- Name ESP
    if ESPConfig.NameESP then
        objects.Name.Text = player.Name
        objects.Name.Position = Vector2.new(pos.X, top.Y - 20)
        objects.Name.Color = color
        objects.Name.Size = ESPConfig.TextSize
        objects.Name.Visible = true
    else
        objects.Name.Visible = false
    end
end

-- ESP Update loop
RunService.RenderStepped:Connect(function()
    if ESPConfig.Enabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                UpdateESP(player)
            end
        end
    end
end)

-- Player events
Players.PlayerAdded:Connect(CreateESP)
Players.PlayerRemoving:Connect(RemoveESP)

-- Initialize ESP
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        CreateESP(player)
    end
end

-- Console output
print("WA ESP v1.0 with Aimbot loaded")
print("Aimbot key: MouseButton2 (right click)")
print("ESP toggle: Set ESPConfig.Enabled = true")
